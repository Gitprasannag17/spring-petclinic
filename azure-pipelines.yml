trigger:
- main  # Trigger on changes to the main branch

stages:
- stage: QueryAndDeploy
  displayName: Query and Deploy to AKS
  jobs:
  - job: QueryAndDeployJob
    displayName: Interact with AKS
    pool:
      default

    steps:
    # 1. Install kubectl (if not pre-installed)
    - task: KubectlInstaller@0
      displayName: Install kubectl
      inputs:
        kubectlVersion: 'latest'

    # 2. Configure kubectl to use the Kubernetes Service Connection
    - task: Kubernetes@1
      displayName: Set Kubernetes context
      inputs:
        connectionType: 'Kubernetes Service Connection'
        kubernetesServiceEndpoint: 'aks-service-connection'

    # 4. Deploy application using Kubernetes manifests
    - task: KubernetesManifest@0
      displayName: Deploy Application to AKS
      inputs:
        action: 'deploy'
        kubernetesServiceConnection: 'aks-service-connection'
        namespace: 'default'
        manifests: |
          $(Pipeline.Workspace)/manifest.yaml


    # 5. Verify the deployment
    - script: |
        echo "Verifying deployment..."
        kubectl get pods -n default
        kubectl get svc -n default
      displayName: Verify Deployment